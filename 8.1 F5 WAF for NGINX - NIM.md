

## Install F5 WAF

**Installation**  
```sh title:"Install NGINX App Protect WAF v5"
# Add NGINX Plus Repo
printf "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://pkgs.nginx.com/plus/ubuntu `lsb_release -cs` nginx-plus\n" | sudo tee /etc/apt/sources.list.d/nginx-plus.list

# Add NGINX App Protect WAF v5 Repo
printf "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://pkgs.nginx.com/app-protect-x-plus/ubuntu `lsb_release -cs` nginx-plus\n" | sudo tee /etc/apt/sources.list.d/nginx-app-protect.list

# Install NGINX App Protect WAF v5 package
sudo apt-get update
sudo apt-get install app-protect-module-plus -y
```


---

## WAF Enforcer and Config Manager
## waf-enforcer and waf-config-mgr

Reference: https://docs.nginx.com/waf/install/docker/#configure-docker  

**Docker Install**  
```shell title:"Set up Docker apt repo"
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# Install Docker packages
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
```

**F5 Container Registry**  
```sh title:"Configure Docker to interact with F5 Container Registry"
sudo mkdir -p /etc/docker/certs.d/private-registry.nginx.com
sudo cp /home/ubuntu/nginx-one-license/nginx-repo.crt /etc/docker/certs.d/private-registry.nginx.com/client.cert
sudo cp /home/ubuntu/nginx-one-license/nginx-repo.key /etc/docker/certs.d/private-registry.nginx.com/client.key
```

**Pull images**  
```sh title:"Pull images - Take note of versions"
docker pull private-registry.nginx.com/nap/waf-enforcer:5.8.0
docker pull private-registry.nginx.com/nap/waf-config-mgr:5.8.0
```

**Create directories & set permissions**  
```sh title:"Create folder and change ownership"
# Directory for WAF v5 services
sudo mkdir -p /opt/app_protect/config /opt/app_protect/bd_config
sudo chown -R 101:101 /opt/app_protect/

# Directory for Policy Bundle .tgz files
sudo mkdir -p /etc/app_protect/bundles
sudo chown -R 101:101 /etc/app_protect/bundles
```

**Docker Compose File**  
```sh title:"Create docker-file.yml"
sudo mkdir -p /home/ubuntu/waf-enforcer-conf-mgr/
cd /home/ubuntu/waf-enforcer-conf-mgr/
cat <<EOF >>docker-compose.yml
services:
  waf-enforcer:
    container_name: waf-enforcer
    image: private-registry.nginx.com/nap/waf-enforcer:5.8.0
    environment:
      - ENFORCER_PORT=50000
    ports:
      - "50000:50000"
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
    networks:
      - waf_network
    restart: always

  waf-config-mgr:
    container_name: waf-config-mgr
    image: private-registry.nginx.com/nap/waf-config-mgr:5.8.0
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
      - /opt/app_protect/config:/opt/app_protect/config
      - /etc/app_protect/conf:/etc/app_protect/conf
      - /etc/app_protect/bundles:/etc/app_protect/bundles
    restart: always
    network_mode: none
    depends_on:
      waf-enforcer:
        condition: service_started

networks:
  waf_network:
    driver: bridge
EOF
```

**Run Docker Compose**  
```sh title:"Start containers"
cd /home/ubuntu/waf-enforcer-conf-mgr
sudo docker compose up -d
```


---

## WAF Compiler - NIM

**Create compiler.tzr.gz - Connected**  
```sh
sudo apt-get update -y
sudo mkdir -p /etc/ssl/nginx/
sudo mv nginx-repo.crt /etc/ssl/nginx/
sudo mv nginx-repo.key /etc/ssl/nginx/

wget -qO - https://cs.nginx.com/static/keys/nginx_signing.key \
    | gpg --dearmor \
    | sudo tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null

printf "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \
https://pkgs.nginx.com/nms/ubuntu $(lsb_release -cs) nginx-plus\n" | \
sudo tee /etc/apt/sources.list.d/nms.list

sudo wget -q -O /etc/apt/apt.conf.d/90pkgs-nginx https://cs.nginx.com/static/files/90pkgs-nginx
mkdir -p compiler && cd compiler
sudo apt-get update

sudo apt-get download nms-nap-compiler-v5.550.0
cd ../
mkdir -p compiler/compiler.deps
sudo apt-get install --download-only --reinstall --yes --print-uris \
  nms-nap-compiler-v5.527.0 \
  | grep ^\' \
  | cut -d\' -f2 \
  | xargs -n 1 wget -P ./compiler/compiler.deps
tar -czvf compiler.tar.gz compiler/
```

**Move all files from Connected to Disconnected VM**  

**Install NIM WAF Compiler - Disconnected**  
```sh
tar -xzvf compiler.tar.gz
sudo dpkg -i ./compiler/compiler.deps/*.deb
sudo dpkg -i ./compiler/*.deb
```

**Restart NIM**  
```sh
sudo systemctl restart nms
```

## Configure NGINX Agent

**Edit NGINX Agent Config File**  
```sh
sudo vim /etc/nginx-agent/nginx-agent.conf
```

**Add settings**  
```yaml
config_dirs: "/etc/nginx:/usr/local/etc/nginx:/usr/share/nginx/modules:/etc/nms:/etc/app_protect"
extensions:
  - nginx-app-protect
nginx_app_protect:
  report_interval: 15s
  precompiled_publication: true
```

**Restart NGINX Agent**  
```sh
sudo systemctl restart nginx-agent
```

**Stop Docker**  
```
docker compose down
```

**Update Docker Compose file**  
```yaml
services:
  waf-enforcer:
    container_name: waf-enforcer
    image: private-registry.nginx.com/nap/waf-enforcer:latest
    user: 101:1001
    environment:
      - ENFORCER_PORT=50000
    ports:
      - "50000:50000"
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
      - /etc/nms:/etc/nms
    networks:
      - waf_network
    restart: always

  waf-config-mgr:
    container_name: waf-config-mgr
    image: private-registry.nginx.com/nap/waf-config-mgr:latest
    user: 101:1001
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
      - /opt/app_protect/config:/opt/app_protect/config
      - /etc/app_protect/conf:/etc/app_protect/conf
      - /etc/app_protect/bundles:/etc/app_protect/bundles
      - /etc/nms:/etc/nms
    restart: always
    network_mode: none
    depends_on:
      waf-enforcer:
        condition: service_started

networks:
  waf_network:
    driver: bridge
```

**Start Docker**  
```sh
docker compose up -d
```


---

## NGINX Config

**Load F5 WAF Module**  
```sh
sudo vim /etc/nginx/nginx.conf
```

**/etc/nginx/nginx.conf**  
```nginx title:"/etc/nginx/nginx.conf"
user  nginx;
worker_processes  auto;

load_module modules/ngx_http_app_protect_module.so; # Load F5 WAF Module

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    app_protect_enforcer_address 127.0.0.1:50000; # WAF Enforcer

    include /etc/nginx/conf.d/*.conf;
}
```

**Configure WAF Gateway**  
```sh
sudo vim /etc/nginx/conf.d/waf_gateway.conf
```
  
**/etc/nginx/conf.d/waf_gateway.conf**  
```nginx
upstream pet-store-waf {
    zone api_upstreams 64k;
    server 10.1.1.4:80;
}

server {
    listen 9200;
    
    location /pet-store-api/ {
        
        app_protect_enable on;
        
        proxy_pass http://pet-store-waf/v2/;
        proxy_set_header Host $host;
    }
}
```

---

## Test F5 WAF

```sh
# Regular Traffic
curl http://10.1.1.8:9200/pet-store-api/pet/1

# XSS
curl "http://10.1.1.8:9200/pet-store-api/pet/<script>alert();</script>/1"
```
