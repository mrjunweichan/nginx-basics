


## JWT
  
**Create JSON Web Key File**  
```shell
sudo mkdir -p /etc/nginx/secrets/
SECRET="nginx-demo-secret"; BASE64URL=$(echo -n "$SECRET" | openssl base64 | tr '+/' '-_' | tr -d '='); echo -e "{\n  \"keys\": [\n    {\n      \"kty\": \"oct\",\n      \"k\": \"$BASE64URL\",\n      \"alg\": \"HS256\"\n    }\n  ]\n}" > /etc/nginx/secrets/api_secret.key
```
  
**Update API Gateway Config at /etc/nginx/conf.d/api_gateway.conf**  
```sh
cat <<EOF >/etc/nginx/conf.d/api_gateway.conf
upstream pet-store {
    zone api_upstreams 64k;
    server 10.1.1.4:80;
}
server {
    listen 443 ssl;
    server_name example.api;
    ssl_certificate        /etc/nginx/ssl/server-cert.pem;
    ssl_certificate_key    /etc/nginx/ssl/server-key.pem;
    ssl_client_certificate /etc/nginx/ssl/ca-cert.pem;
    ssl_verify_client on;
    ssl_verify_depth 2;
    
    location /pet-store-api/ {
        proxy_pass http://pet-store/v2/;
        proxy_set_header Host $host;
    }
    
    location /pet-store-api/store/ {
        auth_jwt "store api" token=$arg_token;
        auth_jwt_key_file /etc/nginx/secrets/api_secret.key;
        
        proxy_set_header Host $host;
        proxy_set_header API-Client $jwt_claim_sub;
        
		proxy_pass http://pet-store/v2/store/;
    }
}
EOF
```
  
---
**JWT Token**
```txt
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE3NTEyNzA2NTgsImV4cCI6MTc4MjgwNjY1OCwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoianJvY2tldEBleGFtcGxlLmNvbSIsIkdpdmVuTmFtZSI6IkpvaG5ueSIsIlN1cm5hbWUiOiJSb2NrZXQiLCJFbWFpbCI6Impyb2NrZXRAZXhhbXBsZS5jb20iLCJSb2xlIjpbIk1hbmFnZXIiLCJQcm9qZWN0IEFkbWluaXN0cmF0b3IiXX0.JU6k0TzK9zNipd8eSk3NGBvprk10MICcI9Bl1HvGM-w
```
  
**Firefox Browser**
```shell
https://example.api/pet-store-api/store/inventory/?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE3NTExODg0MTUsImV4cCI6MTc4MjcyNDQxNSwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoiYWRtaW5AZXhhbXBsZS5jb20iLCJOYW1lIjoiVXNlciIsIkVtYWlsIjoidXNlckBleGFtcGxlLmNvbSJ9.drkO2-OsmPkYtL7TDD3G21KIKeKbQT5r4AyYdvsYj0g
```
  
**Jumphost Terminal**
```shell
curl --cert-type P12 \
     --cert /home/ubuntu/client-cert.p12: \
     -k "https://example.api/pet-store-api/store/inventory/?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE3NTExODg0MTUsImV4cCI6MTc4MjcyNDQxNSwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoiYWRtaW5AZXhhbXBsZS5jb20iLCJOYW1lIjoiVXNlciIsIkVtYWlsIjoidXNlckBleGFtcGxlLmNvbSJ9.drkO2-OsmPkYtL7TDD3G21KIKeKbQT5r4AyYdvsYj0g"
```
  
  
  
---
  
## Key Value Store
  
**Configure API Gateway**  
```sh
sudo vim /etc/nginx/conf.d/api_gateway.conf
```
  
**/etc/nginx/conf.d/api_gateway.conf**  
```nginx
keyval_zone zone=denylist_zone:1m type=ip state=denylist_zone.keyval;
keyval $remote_addr $target zone=denylist_zone;

upstream pet-store {
    zone api_upstreams 64k;
    server 10.1.1.4:80;
}
server {
    listen 443 ssl;
    server_name example.api;
    ssl_certificate        /etc/nginx/ssl/server-cert.pem;
    ssl_certificate_key    /etc/nginx/ssl/server-key.pem;
    ssl_client_certificate /etc/nginx/ssl/ca-cert.pem;
    ssl_verify_client on;
    ssl_verify_depth 2;
    
    if ($target) {
        return 403;
    }
    
    location /pet-store-api/ {
        proxy_pass http://pet-store/v2/;
        proxy_set_header Host $host;
    }
    
    location /pet-store-api/store/ {
        auth_jwt "store api" token=$arg_token;
        auth_jwt_key_file /etc/nginx/secrets/api_secret.key;
        
        proxy_set_header Host $host;
        proxy_set_header API-Client $jwt_claim_sub;
        
		proxy_pass http://pet-store/v2/store/;
    }
}
```
  
**Add IP address to Deny List Key Value Store**  
```sh
curl -X POST -d '{"10.1.1.5":"1"}' -s 'http://localhost:8080/api/9/http/keyvals/denylist_zone'
```
  
**Update Deny List Key Value Store**  
```sh
curl -X PATCH -d '{"10.1.1.5":"0"}' -s 'http://localhost:8080/api/9/http/keyvals/denylist_zone'
```
  
**Get List of Key Value Store**  
```sh
curl -X GET http://localhost:8080/api/9/http/keyvals/denylist_zone
```

