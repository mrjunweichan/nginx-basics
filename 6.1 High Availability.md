
## Active - Passive


## Install NGINX Plus with nginx-ha-keepalived

**Both Nodes**
```sh title:"Include nginx-ha-keepalived"
sudo apt-get install -y nginx-ha-keepalived
```

**Both Nodes**
```sh title:"Run setup script"
. nginx-ha-setup
```

| Node        | Internal IP (self) | Peer Node IP | Cluster VIP  | Role   |
| ----------- | ------------------ | ------------ | ------------ | ------ |
| **Primary** | `10.1.1.6`         | `10.1.1.7`   | `10.1.1.100` | MASTER |
| **Peer**    | `10.1.1.7`         | `10.1.1.6`   | `10.1.1.100` | BACKUP |

**Verify State**
```sh title:"Verify keepalived State"
cat /var/run/nginx-ha-keepalived.state
```

**View Config**
```sh title:"View keepalived config"
cat /etc/keepalived/keepalived.conf
```

## Verify Active-Passive behavior

**Primary Node**
```sh
sudo systemctl stop keepalived
```

**Peer Node**
```sh
cat /var/run/nginx-ha-keepalived.state
```

---

## Active - Active

**What is Active Active**
2 or more active nodes that handle traffic at the same time
Achieved using multiple active IP addresses
Each IP hosted on single NGINX instance
Keepalived configuration ensures these IP addresses are spread across 2 or more active nodes

**Why Active Active**
Used to increase capacity of load-balanced cluster
If single node in active-active pair were to fail, capacity will be halved
Since NGINX cluster do not share configuration or state, use session persistence like `sticky cookies` that do not rely on server-side state


## Update Keepalived Configuration


**Keepalived Virtual IP Plan**

| Node           | Internal IP (self) | vrrp_instance | virtual_ipaddress | virtual_router_id | priority |
| -------------- | ------------------ | ------------- | ----------------- | ----------------- | -------- |
| **Active - 1** | `10.1.1.6`         | VI_1          | `10.1.1.100`      | 51                | 101      |
| **Active - 1** | `10.1.1.6`         | VI_2          | `10.1.1.101`      | 61                | 100      |
| **Active - 2** | `10.1.1.7`         | VI_1          | `10.1.1.100`      | 51                | 100      |
| **Active - 2** | `10.1.1.7`         | VI_2          | `10.1.1.101`      | 61                | 101      |

**Primary Node - /etc/keepalived/keepalived.conf**
```nginx title:"/etc/keepalived/keepalived.conf"
global_defs {
        vrrp_version 3
}

vrrp_script chk_manual_failover {
        script "/usr/lib/keepalived/nginx-ha-manual-failover"
        interval 10
        weight 50
}

vrrp_script chk_nginx_service {
        script "/usr/lib/keepalived/nginx-ha-check"
        interval 3
        weight 50
}

vrrp_instance VI_1 {
        interface ens5
        priority 101
        virtual_router_id 51
        advert_int 1
        accept
        garp_master_refresh 5
        garp_master_refresh_repeat 1
        unicast_src_ip 10.1.1.6
        unicast_peer {
                10.1.1.7
        }
        virtual_ipaddress {
                10.1.1.100
        }
        track_script {
                chk_nginx_service
                chk_manual_failover
        }
        notify "/usr/lib/keepalived/nginx-ha-notify"
}

vrrp_instance VI_2 {
        interface ens5
        priority 100
        virtual_router_id 61
        advert_int 1
        accept
        garp_master_refresh 5
        garp_master_refresh_repeat 1
        unicast_src_ip 10.1.1.6
        unicast_peer {
                10.1.1.7
        }
        virtual_ipaddress {
                10.1.1.101
        }
        track_script {
                chk_nginx_service
                chk_manual_failover
        }
        notify "/usr/lib/keepalived/nginx-ha-notify"
}
```


**Peer Node - /etc/keepalived/keepalived.conf**
```nginx title:"/etc/keepalived/keepalived.conf"
global_defs {
        vrrp_version 3
}

vrrp_script chk_manual_failover {
        script "/usr/lib/keepalived/nginx-ha-manual-failover"
        interval 10
        weight 50
}

vrrp_script chk_nginx_service {
        script "/usr/lib/keepalived/nginx-ha-check"
        interval 3
        weight 50
}

vrrp_instance VI_1 {
        interface ens5
        priority 100
        virtual_router_id 51
        advert_int 1
        accept
        garp_master_refresh 5
        garp_master_refresh_repeat 1
        unicast_src_ip 10.1.1.7
        unicast_peer {
                10.1.1.6
        }
        virtual_ipaddress {
                10.1.1.100
        }
        track_script {
                chk_nginx_service
                chk_manual_failover
        }
        notify "/usr/lib/keepalived/nginx-ha-notify"
}

vrrp_instance VI_2 {
        interface ens5
        priority 101
        virtual_router_id 61
        advert_int 1
        accept
        garp_master_refresh 5
        garp_master_refresh_repeat 1
        unicast_src_ip 10.1.1.7
        unicast_peer {
                10.1.1.6
        }
        virtual_ipaddress {
                10.1.1.101
        }
        track_script {
                chk_nginx_service
                chk_manual_failover
        }
        notify "/usr/lib/keepalived/nginx-ha-notify"
}
```

**Both Nodes**
```sh title:"Restart keepalived"
sudo systemctl restart keepalived 
```

**Both Nodes - Verify VIP on nodes**
```sh title:"Verify"
ip addr show ens5 | grep 10.1.1.10
# 10.1.1.6 should show 10.1.1.100
# 10.1.1.7 should show 10.1.1.101
```

**Both Nodes**
```sh title:"Test keepalived to NGINX"
curl -I http://10.1.1.100/
curl -I http://10.1.1.101/
```

## Verify Active-Active behavior

**Any Node**
```sh
sudo systemctl stop keepalived
```

**Any Node**
```sh
ip addr show ens5 | grep 10.1.1.10
```


---

## Active - Active - Passive

**Why add a Passive Node**
Many organizations have strict requirements on levels of redundancy and a two node activeâ€‘passive system may not meet these requirements  
Adding a third node configured to take over in the event that both other nodes are down, provides further redundancy while keeping the configuration simple  
This also allows for maintenance on a node without losing redundancy  

**Behavior**

| Scenario                        | Who ends up owning 10.1.1.100 | Who ends up owning 10.1.1.101 | Traffic served by                |
| ------------------------------- | ----------------------------- | ----------------------------- | -------------------------------- |
| All three nodes healthy         | Active-1                      | Active-2                      | Active-1+2 (50 % traffic)        |
| Only Active-1 down              | Active-2                      | Active-2                      | Active-2 only (100 % traffic)    |
| Only Active-2 down              | Active-1                      | Active-1                      | Active-1 only (100 % traffic)    |
| Active-1 and Active-2 both down | Passive                       | Passive                       | Passive node (disaster recovery) |
| Passive down (actives still up) | No change                     | No change                     | Still active-active as normal    |

## Install nginx-ha-keepalived

**Both Nodes**
```sh title:"Run setup script"
. nginx-ha-setup
```


## Update Keepalived Configuration


**Keepalived Virtual IP Plan**

| Node           | Internal IP (self) | vrrp_instance | virtual_ipaddress | virtual_router_id | priority | Role            |
| -------------- | ------------------ | ------------- | ----------------- | ----------------- | -------- | --------------- |
| **Active - 1** | `10.1.1.6`         | VI_1          | `10.1.1.100`      | 51                | 101      | MASTER for .100 |
| **Active - 1** | `10.1.1.6`         | VI_2          | `10.1.1.101`      | 61                | 100      | BACKUP for .101 |
| **Active - 2** | `10.1.1.7`         | VI_1          | `10.1.1.100`      | 51                | 100      | BACKUP for .100 |
| **Active - 2** | `10.1.1.7`         | VI_2          | `10.1.1.101`      | 61                | 101      | MASTER for .101 |
| **Passive**    | `10.1.1.8`         | VI_1          | `10.1.1.100`      | 51                | 99       | BACKUP for .100 |
| **Passive**    | `10.1.1.8`         | VI_2          | `10.1.1.101`      | 61                | 99       | BACKUP for .101 |


**Active 1 Node - add Passive Node IP to config /etc/keepalived/keepalived.conf**
```nginx title:"/etc/keepalived/keepalived.conf"
...

vrrp_instance VI_1 {
        ...
        unicast_peer {
                10.1.1.7
                10.1.1.8
        }
        ...
}

vrrp_instance VI_2 {
        ...
        unicast_peer {
                10.1.1.7
                10.1.1.8
        }
        ...
}
```

**Active 2 Node - add Passive Node IP to config /etc/keepalived/keepalived.conf**
```nginx title:"/etc/keepalived/keepalived.conf"
...

vrrp_instance VI_1 {
        ...
        unicast_peer {
                10.1.1.6
                10.1.1.8
        }
        ...
}

vrrp_instance VI_2 {
        ...
        unicast_peer {
                10.1.1.6
                10.1.1.8
        }
        ...
}
```

**Passive Node - /etc/keepalived/keepalived.conf**
```nginx title:"/etc/keepalived/keepalived.conf"
global_defs {
        vrrp_version 3
}

vrrp_script chk_manual_failover {
        script "/usr/lib/keepalived/nginx-ha-manual-failover"
        interval 10
        weight 50
}

vrrp_script chk_nginx_service {
        script "/usr/lib/keepalived/nginx-ha-check"
        interval 3
        weight 50
}

vrrp_instance VI_1 {
        interface ens5
        priority 99
        virtual_router_id 51
        advert_int 1
        accept
        garp_master_refresh 5
        garp_master_refresh_repeat 1
        unicast_src_ip 10.1.1.8
        unicast_peer {
		        10.1.1.6
                10.1.1.7
        }
        virtual_ipaddress {
                10.1.1.100
        }
        track_script {
                chk_nginx_service
                chk_manual_failover
        }
        notify "/usr/lib/keepalived/nginx-ha-notify"
}

vrrp_instance VI_2 {
        interface ens5
        priority 99
        virtual_router_id 61
        advert_int 1
        accept
        garp_master_refresh 5
        garp_master_refresh_repeat 1
        unicast_src_ip 10.1.1.8
        unicast_peer {
		        10.1.1.6
                10.1.1.7
        }
        virtual_ipaddress {
                10.1.1.101
        }
        track_script {
                chk_nginx_service
                chk_manual_failover
        }
        notify "/usr/lib/keepalived/nginx-ha-notify"
}
```

**All Nodes**
```sh title:"Restart keepalived"
sudo systemctl restart keepalived 
```

**All Nodes - Verify VIP on nodes**
```sh title:"Verify"
ip addr show ens5 | grep 10.1.1.10
# 10.1.1.6 should show 10.1.1.100
# 10.1.1.7 should show 10.1.1.101
# 10.1.1.8 should show nothing
```


## Verify Active-Active-Passive behavior

**Both Active Node**
```sh
sudo systemctl stop keepalived
```

**Passive Node**
```sh
ip addr show ens5 | grep 10.1.1.10
```


