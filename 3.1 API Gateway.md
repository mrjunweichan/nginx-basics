


## API Gateway
  
**Configure API Gateway at /etc/nginx/conf.d/api_gateway.conf**  
```bash
cat <<EOF >/etc/nginx/conf.d/api_gateway.conf
upstream pet-store {
    zone api_upstreams 64k;
    server 10.1.1.4:80;
}

server {
    listen 9100;
    
    location /pet-store-api/ {
        proxy_pass http://pet-store/v2/;
        proxy_set_header Host $host;
    }
}
EOF
```

> **upstream pet-store** – Define an upstream group with the name 'pet-store'  
> 
> **zone** – Create a shared memory zone  
>     **api_upstreams 64k** – Name zone 'api-upstreams' with 64KB of memory  
>     **server 10.1.1.4:80** – Add backend server at IP 10.1.1.4:80 to 'pet-store'  
> 
> **listen 9100** – Listen for plain HTTP traffic on port 9100  
> 
> **location** – Match request prefix /pet-store-api/  
>     **proxy_pass http://pet-store/v2/** – Forward request to 'pet-store'/v2/  
>     http://10.1.1.6:9100/pet-store-api/x/xx -> http://10.1.1.4:9100/pet-store/v2/x/xx  
> 
> **proxy_set_header Host $host** – Pass original Host header from client to backend  

**Zone is required when using modules such as:**  
Rate Limiting - to count request per IP across all workers  
Caching - to store file 'keys' so workers find files fast  
Sticky session - to store session strings  

**Rate limit example:  **
1,000 unique concurrent users
Memory per entry = 128 bytes (64-bits)
Total Memory = Number of unique keys x Memory per entry

**Caching example:  **
1,000 unique objects to cache
Memory per entry = 256 bytes (average, depends on key length)
Total Memory = Number of cache objects x 256 bytes

## Preserve Headers for Upstream

`proxy_set_headers` directive used to customize or pass along specific HTTP headers to upstream server when request is proxied using `proxy_pass`  

> **Best Practice**
> To always set the following `host` headers to preserve the client’s original context:  

**Best Practice in most production setup**  
```nginx
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
```


---
## Jump Host (Firefox Browser)
  
**Get Pet with ID 5**  
```
http://example.api:9100/pet-store-api/pet/5
```
  
**Get All Pets in pending status**  
```
http://example.api:9100/pet-store-api/pet/findByStatus?status=pending
```
  
**Get store inventory**  
```
http://example.api:9100/pet-store-api/store/inventory
```

  
---
## Jump Host (Web Shell)
  
**Get Pet with ID 5**  
```shell
curl "http://10.1.1.6:9100/pet-store-api/pet/5" | jq
```
  
**Get All Pets in pending status**  
```shell
curl "http://10.1.1.6:9100/pet-store-api/pet/findByStatus?status=pending" | jq
```
  
**Get store inventory**  
```shell
curl "http://10.1.1.6:9100/pet-store-api/store/inventory" | jq
```








