

## Install F5 WAF


https://docs.nginx.com/nginx-app-protect-waf/v5/admin-guide/install/

**Dependencies**  
NGINX Plus already installed  
NGINX One Console already connected  

## NAP v5

**Installation**  
```sh title:"Install NGINX App Protect WAF v5"
# Add F5 WAF Signing Key
wget -qO - https://cs.nginx.com/static/keys/app-protect-security-updates.key | \
gpg --dearmor | sudo tee /usr/share/keyrings/app-protect-security-updates.gpg > /dev/null

# Add NGINX Plus Repo
printf "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \
https://pkgs.nginx.com/app-protect/ubuntu `lsb_release -cs` nginx-plus\n" | \
sudo tee /etc/apt/sources.list.d/nginx-app-protect.list

# Add NGINX App Protect WAF v5 Repo
printf "deb [signed-by=/usr/share/keyrings/app-protect-security-updates.gpg] \
https://pkgs.nginx.com/app-protect-security-updates/ubuntu `lsb_release -cs` nginx-plus\n" | \
sudo tee /etc/apt/sources.list.d/app-protect-security-updates.list

# Install NGINX App Protect WAF v5 package
sudo apt-get update
sudo apt-get install app-protect -y
```

**Create directories & set permissions**  
```sh title:"Create folder and change ownership"
# Directory for WAF v5 services
sudo mkdir -p /opt/app_protect/config /opt/app_protect/bd_config
sudo chown -R 101:101 /opt/app_protect/

# Directory for Policy Bundle .tgz files
sudo mkdir -p /etc/app_protect/bundles
sudo chown -R 101:101 /etc/app_protect/bundles
```

## waf-enforcer and waf-config-mgr

Reference: https://docs.nginx.com/waf/install/docker/#configure-docker  

**Docker Install**  
```shell title:"Set up Docker apt repo"
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# Install Docker packages
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
```

**F5 Container Registry**  
```sh title:"Configure Docker to interact with F5 Container Registry"
sudo mkdir -p /etc/docker/certs.d/private-registry.nginx.com
sudo cp /home/ubuntu/nginx-one-license/nginx-repo.crt /etc/docker/certs.d/private-registry.nginx.com/client.cert
sudo cp /home/ubuntu/nginx-one-license/nginx-repo.key /etc/docker/certs.d/private-registry.nginx.com/client.key
```

**Pull images**  
```sh title:"Pull images - Take note of versions"
docker pull private-registry.nginx.com/nap/waf-enforcer:5.10.0
docker pull private-registry.nginx.com/nap/waf-config-mgr:5.10.0
```

**Docker Compose File**  
```sh title:"Create docker-file.yml"
sudo mkdir -p /home/ubuntu/waf-enforcer-conf-mgr/
cd /home/ubuntu/waf-enforcer-conf-mgr/
cat <<EOF >>docker-compose.yml
services:
  waf-enforcer:
    container_name: waf-enforcer
    image: private-registry.nginx.com/nap/waf-enforcer:5.10.0
    environment:
      - ENFORCER_PORT=50000
    ports:
      - "50000:50000"
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
    networks:
      - waf_network
    restart: always

  waf-config-mgr:
    container_name: waf-config-mgr
    image: private-registry.nginx.com/nap/waf-config-mgr:5.10.0
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
      - /opt/app_protect/config:/opt/app_protect/config
      - /etc/app_protect/conf:/etc/app_protect/conf
      - /etc/app_protect/bundles:/etc/app_protect/bundles
    restart: always
    network_mode: none
    depends_on:
      waf-enforcer:
        condition: service_started

networks:
  waf_network:
    driver: bridge
EOF
```

**Run Docker Compose**  
```sh title:"Start containers"
cd /home/ubuntu/waf-enforcer-conf-mgr
sudo docker compose up -d
```


## NGINX One Console

**Create Policy**  

**App Protect > Policies > Add Policy**  
>	Enter: Name  
>	Select: Enforcement Mode  
>	Select: NGINX Strict  
>	Select: Apply  

**App Protect > Policies > Add Deployment**  
>	Select: Policy  
>	Select: Instance  
>	Enter: Policy file path  
>	Select: Next  

**Policy File Path**  
```sh title:"Strict Policy Path"
/etc/app_protect/bundles/strict-blocking.tgz
```


---

## NGINX Config

**Load F5 WAF Module**  
```sh
sudo vim /etc/nginx/nginx.conf
```

**/etc/nginx/nginx.conf**  
```nginx title:"/etc/nginx/nginx.conf"
user  nginx;
worker_processes  auto;

load_module modules/ngx_http_app_protect_module.so; # Load F5 WAF Module

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    app_protect_enforcer_address 127.0.0.1:50000; # WAF Enforcer

    include /etc/nginx/conf.d/*.conf;
}
```

**Configure WAF Gateway**  
```sh
sudo vim /etc/nginx/conf.d/waf_gateway.conf
```
  
**/etc/nginx/conf.d/waf_gateway.conf**  
```nginx
upstream pet-store-waf {
    zone api_upstreams 64k;
    server 10.1.1.4:80;
}

server {
    listen 9200;
    
    location /pet-store-api/ {
        
        app_protect_enable on;
        
        proxy_pass http://pet-store-waf/v2/;
        proxy_set_header Host $host;
    }
}
```


---

## Test F5 WAF

```sh
# Regular Traffic
curl http://10.1.1.8:9200/pet-store-api/pet/1

# XSS
curl "http://10.1.1.8:9200/pet-store-api/pet/<script>alert();</script>/1"
```
