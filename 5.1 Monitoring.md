


## Prometheus

Prometheus is a powerful open-source monitoring and alerting toolkit purpose-built for dynamic, cloud-native environments
- **Scraps** metrics from configured targets (like **NGINX**, Linux nodes, custom applications) at regular intervals
- **Stores** those metrics in an embedded time-series database with multi-dimensional labels
- **Queries** data via `PromQL` enabling real-time troubleshooting, trend analysis and alerting
  
  
**/etc/nginx/nginx.conf**  
```nginx
user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log info;
pid        /var/run/nginx.pid;

load_module modules/ngx_http_js_module.so;     # For Prometheus

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
                      
    include       /etc/nginx/includes/log_formats/*.conf;
    
    access_log  /var/log/nginx/access.log  main;
    
    sendfile        on;
    
    keepalive_timeout  65;
    
    include /etc/nginx/conf.d/*.conf;
    
    subrequest_output_buffer_size 32k;        # For Prometheus
}
```
> `ngx_http_js_module.so` Prometheus requires NGINX JavaScript (njs) module  
> `subrequest_output_buffer_size` Increase bufffer size to hold full JSON payload from Prometheus  
  
**/etc/nginx/conf.d/prometheus.conf**  
```nginx
js_import /usr/share/nginx-plus-module-prometheus/prometheus.js;

server {
  listen 9113;           # Default port for Prometheus scraper page
    
      location = /metrics {
        js_content prometheus.metrics;
      }
      
      location /api {
        api;
      } 
}
```
> `js_import` loads njs module that transforms NGX+ metrics into Prometheus compatible format  
> `js_content`defines function called `prometheus.metrics`  
> 	- Makes subrequests to `/api` endpoint to fetch live NGX+ stats  
> 
> When Prometheus hits`/metrics`  
> 	- NGINX runs `prometheus.metrics` function imported from JS module  
> 	- `promethus.metrics` makes a subrequest to `/api` to fetch live NGX+ stats  
> 	- JSON response is parsed and converted into Prometheus exposition format (text-based)  
> 	- Returned as `HTTP` response  

**/etc/prometheus.yml (Pre-created)**  
```yml
global:
  scrape_interval: 15s 
  
  external_labels:
    monitor: 'nginx-monitor'

scrape_configs:  
  - job_name: 'prometheus'
    
    scrape_interval: 5s

    static_configs:
      - targets: ['nginx-plus:9113']  # NGINX Plus container
```

**Remove Caching**

```nginx title:"Configure Load Balancer"
sudo vim /etc/nginx/conf.d/lb.conf
```

```nginx title:"/etc/nginx/conf.d/lb.conf"
upstream backend_servers {
    zone backend_server_zone 64k;
    server 127.0.0.1:9001;
    server 127.0.0.1:9002;
    server 127.0.0.1:9003;
}

server {
    listen 9000;
    server_name www.example.com;
    autoindex on;
    
    location / {
        proxy_pass http://backend_servers/;
        
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IPÂ  $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
	}
}
```
  
  
**Flood HTTP GET requests to endpoint**
Simulate a live website with high volume of traffic for 5 minutes  
```shell
docker run --rm --network host williamyeh/wrk -t4 -c200 -d5m --timeout 2s https://10.1.1.6/pet-store-api/pet/5
```
> `--network host` connects to the NGINX Plus host network  
> `williamyeh/wrk` HTTP benchmarking tool image  
> `-t4 -c200 -d5m` use 4 threads + 200 concurrent HTTP connections + for 5 minutes  
  
  
---
## Grafana

Grafana an open-source analytics and visualization platform that is widely used by DevOps, IT and business teams  
- **Connects** to datasources (like **Prometheus**, Elasticsearch, Loki or PostgreSQL)  
- **Builds** interactive dashboards, charts and alert panels  
- **Notifies** you when thresholds are crossed or anomalies are detected  

**1. Enter Grafana Console**  
1. Navigate to `http://grafana:3000`  
2. Default login is `admin`/`admin`  

**2. Create Prometheus Connection**  
1. In the side menu > Click `Connections` > `Data sources` > `+ Add new data source`  
2. Select `Prometheus`  
3. In `Prometheus server url`, enter `http://prometheus:9090`  
4. Click on `Save & test` at the bottom of the page  

**3. Import NGINX Dashboard**  
1. In the side menu > Click `Dashboards` > `New` > `Import`  
2. Upload `./nginx-grafana.json` file  
3. In `prometheus` dropdown, select the `prometheus` connection created  
4. Click `import`  






